---
title: x264编译问题处理
date: 2019-02-26 23:11:56
tags: x264
categories: ffmpeg
---

在FFmpeg编译结合x264时出现错误： `libx264 not found`

<!-- more -->

在 FFmpeg 项目的 config.log 中有提示： `x264 undefined reference to 'stderr'`

出现这个错误是因为 `x264` 编译失败了，但 `libx264.so` 还是生成了，并且看起来就像是真的编译成功了一样。

检查 x264 的 config.log ，有一行提示 :

```
checking for fseeko(stdin,0,0); in stdio.h... no
```

在 x264 项目的 configure 中，有对 `stdio.h` 文件的检查

```
if cc_check "stdio.h" "" "fseeko(stdin,0,0);" ; then
    define fseek fseeko
    define ftell ftello
elif cc_check "stdio.h" "" "fseeko64(stdin,0,0);" ; then
    define fseek fseeko64
    define ftell ftello64
elif cc_check "stdio.h" "" "_fseeki64(stdin,0,0);" ; then
    define fseek _fseeki64
    define ftell _ftelli64
fi
```

查找网上相同错误，很多是修改 `define fseek fseek` ，这种方式不管用。

因为在 android 的顶层库中，`stdio.h` 做了相应的修改，和标准库已经不相同了。

```
#if __ANDROID_API__ >= 24
int fgetpos(FILE* __fp, fpos_t* __pos) __RENAME(fgetpos64) __INTRODUCED_IN(24);
int fsetpos(FILE* __fp, const fpos_t* __pos) __RENAME(fsetpos64) __INTRODUCED_IN(24);
int fseeko(FILE* __fp, off_t __offset, int __whence) __RENAME(fseeko64) __INTRODUCED_IN(24);
off_t ftello(FILE* __fp) __RENAME(ftello64) __INTRODUCED_IN(24);
#endif /* __ANDROID_API__ >= 24 */
```

因此设置 x264 编译脚本里面 android api 为 24 可以解决这个问题。但低版本还是会有问题。

这篇文章中介绍了一种方法，可以完美解决这个问题 ： [安卓编译caffe错误 'undefined reference to `stderr`'](https://blog.csdn.net/crazyquhezheng/article/details/79034765)

错误原因：

源文件里面使用了大量的标准IO设备：stderr 等，在NDK15以后，这些都不被支持了，编译静态库本身没问题，但是 libx264.so链接时就找不到对应的静态库定义了，所以报错。

解决方法：

根据官网，需要给C编译器制定参数 `CFLAGS=-D__ANDROID_API__=$API`

修改后的 x264 编译脚本

```shell
#!/bin/sh
NDK=/Users/chenliuyong/program/android-ndk-r16b
API=21
PLATFORM=arm-linux-androideabi
SYSROOT=$NDK/platforms/android-$API/arch-arm/
ISYSROOT=$NDK/sysroot
ASM=$ISYSROOT/usr/include/$PLATFORM
TOOLCHAIN=$NDK/toolchains/$PLATFORM-4.9/prebuilt/darwin-x86_64
CPU=arm
PREFIX=$(pwd)/android/$CPU
ADDI_CFLAGS="-marm"
function build_one
{
    ./configure \
    --prefix=$PREFIX \
    --enable-shared \
    --enable-static \
    --enable-pic \
    --disable-asm \
    --disable-cli \
    --disable-thread \
    --host=arm-linux \
    --cross-prefix=$TOOLCHAIN/bin/arm-linux-androideabi- \
    --sysroot=$SYSROOT \
    --extra-cflags="-I$ASM -isysroot $ISYSROOT -D__ANDROID_API__=$API" \
    --extra-ldflags="$ADDI_LDFLAGS"
    make clean
    make
    make install
}
build_one
```

ffmpeg 编译脚本中也需要做对应修改。

